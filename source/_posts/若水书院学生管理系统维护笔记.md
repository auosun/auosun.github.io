---
title: 若水书院学生管理系统维护笔记
date: 2019/4/24 20:46:01
tags:
categories:
- 代码笔记
---

记录自己在维护若水书院管理系统时所犯下的错误和修正方法

<!-- more -->

### 4/24
1. 因为误删 自己抓取的 一言数据库 导致网站学生界面崩溃，改用 一言 官方js接口
``` bash
# /index/view/student/index.html
<script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
<script>
    fetch('https://v1.hitokoto.cn')
        .then(function (res){
            return res.json();
        })
        .then(function (data) {
            var hitokoto = document.getElementById('hitokoto');
            if (data.from =='原创'){
                data.from = '其他';
            }
            hitokoto.innerText = "© "+data.hitokoto+"     —— "+data.from;
        })
        .catch(function (err) {
            console.error(err);
        })
</script>
```
2. 活动删除 出现bug 无法删除  
  出现因素 ： 未将get写入确定之后 同时get地址有误
``` bash
# /admin/view/activity/activity_list.html
layer.confirm('确认要删除吗？', function (index) {
   $.get("{:url('activity/deleteActivity')}", {id: id});
   $(obj).parents("tr").remove();
   layer.msg('已删除!', {icon: 1, time: 1000});
});
```
3. 活动开始没有自动写入数据库开始时间
``` bash
# /index/controller/Admin.php
public function startActivity(Request $request){
    $activityid = $request->param('id');
    ActivityModel::where('status',1)->update(['status' => '-1']);
    ActivityModel::where('id',$activityid)->update(['status' => '1','start_time'=>time()]);
}
```
4. 活动结束 没有自动写入数据库结束时间 没有正确在后台显示结束时间
``` bash
# /index/controller/Admin.php
public function overActivity(Request $request){
    $activityid = $request->param('id');
    ActivityModel::where('id',$activityid)->update(['status' => '-1','over_time'=>time()]);
    StudentModel::where('status', 1)
        ->update(['status' => '0']);
}
-------
# /admin/model/Activity.php
public function getOverTimeAttr($value)
{
    if($value){
        return date('Y/m/d H:i', $value);
    }else{
        return '尚未结束';
    }
}
```
5. 添加活动时 添加活动参与人数的写入
``` bash
# /admin/view/activity/activity_add.html
<div class="row cl">
   <label class="form-label col-xs-4 col-sm-3">参与人数：</label>
   <div class="formControls col-xs-8 col-sm-9">
      <input type="text" class="input-text " placeholder="参与人数" name="number" id="number" value="" >
   </div>
</div>
```
